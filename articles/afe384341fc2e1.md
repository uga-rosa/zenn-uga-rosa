---
title: "Neovim Lua ã®ãŸã‚ã® LuaLS ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Neovim", "Lua", "LSP"]
published: true
---

# ã¯ã˜ã‚ã«

Neovim ã«ã¯ Lua ãŒçµ„è¾¼ã¾ã‚Œã¦ãŠã‚Šã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (init.lua) ã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ Lua ã§æ›¸ã‘ã¾ã™ã€‚
ã—ã‹ã— Lua ã®è¨€èªæ©Ÿèƒ½ã¯ãªã‹ãªã‹è²§å¼±ã§ã‚ã‚Šã€LSP ã®ã‚µãƒãƒ¼ãƒˆãŒãªã„ã¨ä½“é¨“ã¯æ‚ªã„ã§ã™ã€‚
ã§ã™ã®ã§ sumneko æ°ãŒé–‹ç™ºã—ã¦ã„ã‚‹ã“ã¡ã‚‰ã® Language server (ä»¥ä¸‹ `LuaLS` ã¨è¡¨è¨˜) ã‚’å…¥ã‚Œã¦ã„ã‚‹æ–¹ã¯å¤šã„ã§ã—ã‚‡ã†ã€‚

https://github.com/LuaLS/lua-language-server

ä»Šå›ã¯ LuaLS ã‚’ã¡ã‚ƒã‚“ã¨è¨­å®šã—ã€`vim.api` ã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®è£œå®Œãªã©ã‚’ãƒãƒªãƒãƒªåŠ¹ãã‚ˆã†ã«ã—ã¦å¿«é©ã«ã—ã¦ã„ãã¾ã™ã€‚

## ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

ã“ã®è¨˜äº‹ã®ç›®çš„ã¯ LuaLS ã‚’ã„ã„æ„Ÿã˜ã«è¨­å®šã™ã‚‹ã“ã¨ã ã‘ã§ã™ã€‚
nvim-lspconfig ã‚„ mason.nvim ãªã©ã«ã¯è§¦ã‚Œã¾ã›ã‚“ã€‚

## å‚è€ƒå…ƒ

GitHub ã® Wiki ã«å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã€‚

https://github.com/LuaLS/lua-language-server/wiki

## å‹ã®ä»˜ã‘æ–¹

LuaLS ã«å‹æƒ…å ±ã‚’ä¼ãˆã‚‹ã«ã¯ Annotations ã¨å‘¼ã°ã‚Œã‚‹ã‚³ãƒ¡ãƒ³ãƒˆè¨˜æ³•ã‚’ä½¿ã„ã¾ã™ã€‚
ã“ã“ã‚’è¦‹ã¦ãã ã•ã„ã€‚

https://github.com/LuaLS/lua-language-server/wiki/Annotations

# è¨­å®šæ–¹æ³•

LuaLS ã®è¨­å®šã¯ã“ã“ã«ä¸€è¦§ãŒã‚ã‚Šã¾ã™ã€‚

https://github.com/LuaLS/lua-language-server/wiki/Settings

StyLua ã‚’ä½¿ã†ã‹ã‚‰ LuaLS ã® formatter ã¯ç„¡åŠ¹ã«ã—ãŸã„ã€ã ã¨ã‹ semantic highlight è¦ã‚‰ãªã„ã‹ã‚‰åˆ‡ã‚ŠãŸã„ã€ãªã©ã®è¨­å®šãŒã§ãã¾ã™ã€‚

ãã—ã¦ä»Šå›ã®è‚ã«ãªã‚‹ã®ã¯ `workspace.library` ã§ã™ã€‚

## lazy.nvim ã®å ´åˆ

å…ˆã«ã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¾ã™ã€‚

`get_plugin_path()` ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ã‚ˆã£ã¦å®Ÿè£…ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚
ç­†è€…ã¯ lazy.nvim ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

```lua
local lspconfig = require("lspconfig")

---@param plugins string[]
---@return string[]
local function get_plugin_path(plugins)
  local all_plugins = require("lazy.core.config").plugins
  local paths = {}
  for _, name in ipairs(plugins) do
    if all_plugins[name] then
      table.insert(paths, all_plugins[name].dir)
    else
      vim.notify("Invalid plugin name: " .. name)
    end
  end
  return paths
end

---@param plugins string[]
---@return string[]
local function library(plugins)
  local paths = get_plugin_path(plugins)
  table.insert(paths, vim.fn.stdpath("config"))
  table.insert(paths, vim.env.VIMRUNTIME)
  table.insert(paths, "${3rd}/luv/library")
  table.insert(paths, "${3rd}/busted/library")
  table.insert(paths, "${3rd}/luassert/library")
  return paths
end

lspconfig.lua_ls.setup({
  settings = {
    Lua = {
      runtime = {
        version = "LuaJIT",
      },
      workspace = {
        library = library({ "lazy.nvim", "nvim-insx" }),
        checkThirdParty = false,
      },
    },
  },
})
```

`workspace.library` ã¯ãƒ‘ã‚¹ã®é…åˆ—ã§ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å ´æ‰€ã‚’ç¤ºã—ã¾ã™ã€‚

`library()` é–¢æ•°ã¯æŒ‡å®šã—ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒ‘ã‚¹ã‚’æ¤œç´¢ã—ã€æ›´ã« Neovim ã‚„ LuaLS ã®çµ„è¾¼ã¿ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã®ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¦è¿”ã—ã¾ã™ã€‚

`vim.fn.stdpath("config")` ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®å ´æ‰€ã§ã™ã€‚
è‡ªåˆ†ã§å®šç¾©ã—ãŸä¾¿åˆ©é–¢æ•°ãªã©ã®è£œå®ŒãŒåŠ¹ãã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

`vim.env.VIMRUNTIME` ã¯ `doc/` ã‚„ `ftplugin/` ãªã©ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ‘ã‚¹ã§ã™ã€‚
ã“ã‚Œã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ `vim.fn.*` ã‚„ `vim.api.*` ãªã©ã®è£œå®ŒãŒåŠ¹ãã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

https://github.com/neovim/neovim/tree/master/runtime/lua/vim/_meta

`${3rd}` ã®è¨˜æ³•ã¯ã“ã“ã«ã‚ã‚‹é€šã‚Šã€LuaLS çµ„è¾¼ã¿ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã®ãƒ‘ã‚¹ã«å±•é–‹ã•ã‚Œã¾ã™ã€‚

https://github.com/LuaLS/lua-language-server/wiki/Libraries#manually-applying

`busted` ã‚„ `luassert` ã¯ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã®ã§ `init.lua` ã‚’æ›¸ãã ã‘ãªã‚‰ä¸è¦ã‹ã¨æ€ã„ã¾ã™ã€‚
ãƒ—ãƒ©ã‚°ã‚¤ãƒ³é–‹ç™ºè€…å‘ã‘ã®è¨­å®šã§ã™ã€‚
`luv` ã¯ `vim.uv` (æ—§ `vim.loop`) ãªã®ã§ã€å…¥ã‚Œã¦ãŠã„ãŸæ–¹ãŒä¾¿åˆ©ã‹ã¨æ€ã„ã¾ã™ã€‚

# çµ‚ã‚ã‚Š

å¿«é©ãª Lua ãƒ©ã‚¤ãƒ•ã‚’ï¼
