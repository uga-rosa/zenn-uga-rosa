---
title: "feedkeys ã¨å‘ãåˆã† with Denops"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Vim", "Neovim", "denops"]
published: true
---

# ã¯ã˜ã‚ã«

Vim ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’æ¨¡å€£ã™ã‚‹æ‰‹æ®µã¨ã—ã¦ `feedkeys()` ã¨ã„ã†é–¢æ•°ãŒã‚ã‚Šã¾ã™ã€‚
Insert mode ã§ãƒãƒƒãƒ•ã‚¡ã‚’ç·¨é›†ã™ã‚‹æ–¹æ³•ã®ä¸€ã¤ã§ã‚ã‚Šã€ãƒ‰ãƒƒãƒˆãƒªãƒ”ãƒ¼ãƒˆã«å¯¾å¿œã™ã‚‹ã«ã¯é¿ã‘ã¦é€šã‚Œãªã„é“ã§ã™ã€‚

:::message
`setline()` ãªã©ã®é–¢æ•°ã«ã‚ˆã‚‹ç·¨é›†ã¯ãƒ‰ãƒƒãƒˆãƒªãƒ”ãƒ¼ãƒˆã§ãã¾ã›ã‚“ã€‚API ãã ã•ã„ã€‚
:::

ã—ã‹ã—ã“ã®é–¢æ•°ã¯éåŒæœŸã§ã‚ã‚Šã€é–¢æ•°ã®å‘¼ã³å‡ºã—ã‹ã‚‰ãƒãƒƒãƒ•ã‚¡ã«ç·¨é›†ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¾ã§ãƒ©ã‚°ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯é–¢æ•°ã®å‘¼ã³å‡ºã—è‡ªä½“ã‚’ `await` ã—ãŸã¨ã“ã‚ã§é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚
feedkeys ã®åæ˜ ã‚’åŒæœŸçš„ã«å¾…ã¤ã«ã¯ã©ã†ã™ã‚Œã°ã„ã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

# çµè«–

å…ˆã«çµè«–ã‚’è¿°ã¹ã¾ã™ã€‚

denops-std ã« `helper/keymap.ts` ã‚’å…¥ã‚ŒãŸã®ã§ã“ã‚Œã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚
`\<BS>` ãªã©ã®ç‰¹æ®Šæ–‡å­—ã‚’ä½¿ã†ã«ã¯ `exprQuote` ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚remap ã‚‚æŒ‡å®šã§ãã¾ã™ã€‚

`denops#request()` ã®ä¸­ã§ã¯ä½¿ãˆãªã„ã®ã§ `denops#notify()` ã®ä¸­ã§åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚

```typescript
import { Denops } from "https://deno.land/x/denops_std@v5.2.0/mod.ts";
import * as fn from "https://deno.land/x/denops_std@v5.2.0/function/mod.ts";
import { send } from "https://deno.land/x/denops_std@v5.2.0/helper/keymap.ts";
import { exprQuote as q } from "https://deno.land/x/denops_std@v5.2.0/helper/expr_string.ts";

export async function main(denops: Denops) {
  denops.dispatcher = {
    async sendkeys() {
      await send(denops, [
        "foo",
        { keys: "bar", remap: true },
        q`\<Del>`,
      ]);
      console.log(await fn.getline(denops, "."));
    },
  };
  await denops.cmd(`inoremap A <Cmd>call denops#notify('${denops.name}', 'sendkeys', [])<CR>`);
}
```

# è§£èª¬

## `feedkeys()` ã® `x` ãƒ•ãƒ©ã‚°

`feedkeys()` ã®ãƒ˜ãƒ«ãƒ—ã‚’èª­ã‚€ã¨ã€`x` ã‚„ `x!` ã®ãƒ•ãƒ©ã‚°ã‚’ä½¿ã†ã“ã¨ã§å¾…ã¦ã‚‹ã‚ˆã†ã§ã™ã€‚

:::details :h feedkeys
```help
feedkeys({string} [, {mode}])                                       *feedkeys()*
		Characters in {string} are queued for processing as if they
		come from a mapping or were typed by the user.

		By default the string is added to the end of the typeahead
		buffer, thus if a mapping is still being executed the
		characters come after them.  Use the 'i' flag to insert before
		other characters, they will be executed next, before any
		characters from a mapping.

		The function does not wait for processing of keys contained in
		{string}.

		To include special keys into {string}, use double-quotes
		and "\..." notation |expr-quote|. For example,
		feedkeys("\<CR>") simulates pressing of the <Enter> key. But
		feedkeys('\<CR>') pushes 5 characters.
		The |<Ignore>| keycode may be used to exit the
		wait-for-character without doing anything.

		{mode} is a String, which can contain these character flags:
		'm'	Remap keys. This is default.  If {mode} is absent,
			keys are remapped.
		'n'	Do not remap keys.
		't'	Handle keys as if typed; otherwise they are handled as
			if coming from a mapping.  This matters for undo,
			opening folds, etc.
		'i'	Insert the string instead of appending (see above).
		'x'	Execute commands until typeahead is empty.  This is
			similar to using ":normal!".  You can call feedkeys()
			several times without 'x' and then one time with 'x'
			(possibly with an empty {string}) to execute all the
			typeahead.  Note that when Vim ends in Insert mode it
			will behave as if <Esc> is typed, to avoid getting
			stuck, waiting for a character to be typed before the
			script continues.
			Note that if you manage to call feedkeys() while
			executing commands, thus calling it recursively, then
			all typeahead will be consumed by the last call.
		'!'	When used with 'x' will not end Insert mode. Can be
			used in a test when a timer is set to exit Insert mode
			a little later.  Useful for testing CursorHoldI.

		Return value is always 0.
```
:::

`x` ã ã‘ã ã¨ Insert mode ã‹ã‚‰æŠœã‘ã¦ã—ã¾ã†ã‚‰ã—ã„ã®ã§ã€`x!` ã§è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```vim
inoremap A <Cmd>call <SID>feedkeys('foo')<CR>
function s:feedkeys(keys) abort
  call feedkeys(a:keys, 'n')
  call feedkeys('', 'x!')
endfunction
```

ã¯ã„ã€‚å‹•ãã¾ã›ã‚“ã€‚
ãƒãƒƒãƒ•ã‚¡ã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã—ã€Normal mode ã§ã‚‚ Insert mode ã§ã‚‚ãªã„è¬ã®ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ï¼ˆ`<C-c>` ã§æŠœã‘ã‚‰ã‚Œã¾ã™ï¼‰ã€‚
ã“ã‚Œå‹•ã‹ã›ã‚‹äººã„ãŸã‚‰æ•™ãˆã¦ãã ã•ã„ã€‚

:::details NOTE

ãªãœã‹ã¯åˆ†ã‹ã‚Šã¾ã›ã‚“ãŒã€denops ã‚’çµŒç”±ã™ã‚‹ã¨å‹•ãã¾ã™ã€‚

`batch` ã®ä¸­ã§ `x!` ã®å‘¼ã³å‡ºã—ã‚’ã™ã‚‹ã¨ãƒ€ãƒ¡ãªã®ã§ã€denops ã® await ã«ç§˜å¯†ãŒã‚ã‚Šãã†ã§ã™ã€‚

```typescript
import { Denops } from "https://deno.land/x/denops_std@v5.2.0/mod.ts";
import * as fn from "https://deno.land/x/denops_std@v5.2.0/function/mod.ts";
import { assert, is } from "https://deno.land/x/unknownutil@v3.11.0/mod.ts";
// import { batch } from "https://deno.land/x/denops_std@v5.2.0/batch/mod.ts";

export async function main(denops: Denops) {
  denops.dispatcher = {
    async feedkeys(keys: unknown) {
      assert(keys, is.String);
      await fn.feedkeys(denops, keys, "n");
      await fn.feedkeys(denops, "", "x!");
      // ã“ã‚Œã¯ãƒ€ãƒ¡
      // await batch(denops, async (denops) => {
      //   await fn.feedkeys(denops, keys, "n");
      //   await fn.feedkeys(denops, "", "x!");
      // });
      console.log(await fn.getline(denops, "."));
    },
  };
  await denops.cmd(`inoremap A <Cmd>call denops#notify('${denops.name}', 'feedkeys', ['foo'])<CR>`);
}
```
:::

## Promise ã‚’ä½¿ã†

ã¨ã„ã†ã‚ã‘ã§ã€Vim script ã ã‘ã§ã¯é›£ã—ãã†ã§ã™ã€‚
TypeScript ã®åŠ›ã«é ¼ã‚Šã¾ã—ã‚‡ã†ã€‚

æ‰‹é †ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. `denops#notify` ã§æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã™ã€‚
2. `feedkeys()` ã§ã‚­ãƒ¼ã‚’é€ä¿¡ã™ã‚‹ã€‚
3. Promise ã‚’ä½œæˆã™ã‚‹ã€‚
4. `feedkeys()` ã§ã€ŒVim å´ã‹ã‚‰ Promise ã‚’è§£æ±ºã™ã‚‹é€šçŸ¥ã‚’é€ã‚‹ã‚­ãƒ¼ã€ã‚’é€ä¿¡ã—ã€Promise ã®è§£æ±ºã‚’å¾…ã¤ã€‚
5. `feedkeys()` ã®çµæœãŒåæ˜ ã•ã‚Œã€3. ã§ç”¨æ„ã—ãŸ Promise ãŒè§£æ±ºã•ã‚Œã‚‹ã€‚

ç°¡ç•¥åŒ–ã—ãŸå®Ÿè£…ã‚’ä½¿ã£ã¦æµã‚Œã‚’è¿½ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```typescript
import { Denops } from "https://deno.land/x/denops_std@v5.2.0/mod.ts";
import * as fn from "https://deno.land/x/denops_std@v5.2.0/function/mod.ts";
import * as lambda from "https://deno.land/x/denops_std@v5.2.0/lambda/mod.ts";
import { assert, is } from "https://deno.land/x/unknownutil@v3.11.0/mod.ts";
import {
  exprQuote as q,
  useExprString,
} from "https://deno.land/x/denops_std@v5.2.0/helper/expr_string.ts";

export async function main(denops: Denops) {
  denops.dispatcher = {
    async feedkeys(keys: unknown) {
      assert(keys, is.String);
      // 2.
      await fn.feedkeys(denops, keys, "n");
      // 3.
      const { promise, resolve } = Promise.withResolvers<void>();
      // 4.
      const id = lambda.register(denops, () => resolve(), { once: true });
      await useExprString(denops, async (denops) => {
        await fn.feedkeys(
          denops,
          q`\<Cmd>call denops#notify('${denops.name}', '${id}', [])\<CR>`,
          "n",
        );
      });
      // 5.
      await promise;
      console.log(await fn.getline(denops, "."));
    },
  };
  // 1.
  await denops.cmd(`inoremap A <Cmd>call denops#notify('${denops.name}', 'feedkeys', ['foo'])<CR>`);
}
```

1. ã“ã®æ–¹æ³•ã¯ `denops#request()` ã®ä¸­ã§ã¯å®Ÿç¾ã§ãã¾ã›ã‚“ã€‚
`denops#request()` ã¯ Vim ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã®ã§ `feedkeys()` ã¯åæ˜ ã•ã‚Œãšã€ä¸€ç”Ÿå¾…ã¡ç¶šã‘ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
2. `feedkeys()` ã§ç›®çš„ã®ã‚­ãƒ¼ã‚’é€ä¿¡ã—ã¾ã™ã€‚
3. Promise ã¨ãã‚Œã‚’è§£æ±ºã™ã‚‹ resolve é–¢æ•°ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
4. ã“ã® `resolve()` ã‚’ Vim ã‹ã‚‰å‘¼ã¶ãŸã‚ã€`lambda.register()` ã§ç™»éŒ²ã—ã¾ã™ã€‚
ã“ã‚Œã§ `resolve()` ã‚’ `denops#notify()` ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
`useExprString()` ã‚„ã‚‰ãªã‚“ã‚„ã‚‰æ›¸ã„ã¦ã„ã‚‹ã®ã¯ `\<Cmd>` ã‚„ `\<CR>` ã‚’é€ã‚‹ãŸã‚ã§ã™ã€‚
5. Promise ã®è§£æ±ºã‚’å¾…ã¡ã¾ã™ã€‚

ã“ã‚Œã§ `console.log` ã®çµæœã¯ `foo` ãŒå…¥åŠ›ã•ã‚ŒãŸã‚ã¨ã®ãƒãƒƒãƒ•ã‚¡ã«ãªã‚Šã¾ã™ã€‚

## `helper/keymap.ts`

...çµæ§‹å¤§å¤‰ã§ã™ã­ï¼Ÿ
`feedkeys` ã‚’è¤‡æ•°å›å‘¼ã¶ã¨ `batch()` ã‚’ä½¿ã‚ãªã„ã¨çµæ§‹é…ããªã‚Šã¾ã™ã—ã€ã“ã‚Œã‚’æ¯å›æ›¸ãã®ã¯é¢å€’ã§ã™ã€‚

ã¨ã„ã†è¨³ã§ `denops-std` ã«å…¥ã‚Œã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚

https://deno.land/x/denops_std@v5.2.0/helper/keymap.ts?s=send

ã“ã® `send()` ã‚’ä½¿ãˆã°ç°¡å˜ã«ã€åŒæœŸçš„ãª `feedkeys()` ãŒä½¿ãˆã¾ã™ã€‚

# çµ‚ã‚ã‚Š

`feedkeys()` ã® `x!` ãƒ•ãƒ©ã‚°ã€ãƒã‚°ã£ã¦ã‚‹ã®ã‹ä½¿ã„æ–¹é–“é•ã£ã¦ã‚‹ã®ã‹ã€‚

# å‚è€ƒ

https://github.com/hrsh7th/nvim-kit

`Vim.Keymap` ã«åŒæ§˜ã®å®Ÿè£…ãŒã‚ã‚Šã¾ã™ã€‚ã“ã¡ã‚‰ã¯ Lua ã®ã‚³ãƒ«ãƒ¼ãƒãƒ³ã‚’ä½¿ã£ã¦åæ˜ ã‚’å¾…ã¡ã¾ã™ã€‚
