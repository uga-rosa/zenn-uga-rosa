---
title: "ddu.vim ã§è¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‚’ä»•åˆ‡ã‚Šä»˜ãã§åˆ†ã‘ã‚‹"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Neovim", "Vim", "Lua", "denops"]
published: true
---

# ã¯ã˜ã‚ã«

ddu.vim ã§è¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‚’æ··ãœã¦ä½¿ã†ã¨ãã«ã€ä»•åˆ‡ã‚Šã‚’å‡ºã™æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/fe3242577eef-20230621.png)

ã¾ãŸè¨­å®šã¯ Lua ã§æ›¸ãã¾ã™ã€‚Vim script ã®è¡Œç¶™ç¶šå«Œã„ãªã®ã§ã€‚ã€‚ã€‚

# æ‰‹æ³•

ã“ã‚Œã¯çµ„ã¿è¾¼ã¿ã®æ©Ÿèƒ½ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãƒ€ãƒŸãƒ¼ã®å€™è£œã‚’æ··ãœã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

```
ãƒ€ãƒŸãƒ¼ A
ã‚½ãƒ¼ã‚¹ 1 ã®å€™è£œ
ã‚½ãƒ¼ã‚¹ 1 ã®å€™è£œ
ãƒ€ãƒŸãƒ¼ B
ã‚½ãƒ¼ã‚¹ 2 ã®å€™è£œ
ã‚½ãƒ¼ã‚¹ 2 ã®å€™è£œ
...
```

ã“ã†ã„ã†æ§‹é€ ã§ã™ã€‚
ä»•åˆ‡ã‚Šã® filter ã‚’å…¨ã¦ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã§ã€å¸¸ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã—æ··ã–ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚

ä»•åˆ‡ã‚Šã«ã¯ã“ã‚Œã‚’ä½¿ã„ã¾ã™ã€‚
ä½¿ã„æ–¹ã¯ params ã§è¡¨ç¤ºã™ã‚‹ word ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§ã™ã€‚

https://github.com/Shougo/ddu-source-dummy
- (2023/06/22: uga-rosa/ddu-source-dummy ã¨çµ±åˆã—ã¾ã—ãŸ)

# ãƒ€ãƒŸãƒ¼ã‚’é£›ã°ã—ã¦ã‚«ãƒ¼ã‚½ãƒ«ã‚’å‹•ã‹ã™

ã“ã®ãƒ€ãƒŸãƒ¼ã§ã™ãŒã€ã‚ãã¾ã§ä»•åˆ‡ã‚Šãªã®ã§ã‚«ãƒ¼ã‚½ãƒ«ç§»å‹•ã®ã¨ãã¯ç„¡è¦–ã—ã¦ã»ã—ã„ã§ã™ã‚ˆã­ã€‚
ã¤ã¾ã‚Šã€(1) ã§ j ã‚’æŠ¼ã—ãŸã‚‰ (2) ã¾ã§ç§»å‹•ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```
ãƒ€ãƒŸãƒ¼ A
ã‚½ãƒ¼ã‚¹ 1 ã®å€™è£œ
ã‚½ãƒ¼ã‚¹ 1 ã®å€™è£œ ... (1)
ãƒ€ãƒŸãƒ¼ B
ã‚½ãƒ¼ã‚¹ 2 ã®å€™è£œ ... (2)
ã‚½ãƒ¼ã‚¹ 2 ã®å€™è£œ
```

`move_ignore_dummy(1)` ã‚’ `j` ã«ã€`move_ignore_dummy(-1)` ã‚’ `k` ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚
`item.__sourceName` ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã®ã§ã€ãƒ€ãƒŸãƒ¼ã®æ–‡å­—åˆ—ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’ä»˜ã‘ãªãã¨ã‚‚å®‰å…¨ã«åˆ¤å®šã§ãã¾ã™ã€‚

```lua
---@param items table[] DduItem[]
---@param index number
---@return boolean
local function is_dummy(items, index)
  return items[index] and items[index].__sourceName == "dummy"
end

---@param dir number
---@return function
local function move_ignore_dummy(dir)
  return function()
    local items = vim.fn["ddu#ui#get_items"]()
    local index = vim.fn.line(".") + dir

    while is_dummy(items, index) do
      index = index + dir
    end
    if 1 <= index and index <= #items then
      vim.cmd("normal! " .. index .. "gg")
    end
  end
end
```

ã¤ã„æ˜¨æ—¥å…¥ã‚Œã¦ã‚‚ã‚‰ã£ãŸã°ã‹ã‚Šã® `ddu#ui#get_items()` ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€çœŸä¼¼ã™ã‚‹æ–¹ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

é€†ã®ã“ã¨ã‚’ã™ã‚Œã°ã€ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ç§»å‹•ã®ã‚ˆã†ã«ä½¿ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚

# ä½¿ç”¨ä¾‹

[lspsaga.nvim](https://github.com/nvimdev/lspsaga.nvim) ã® lsp_finder ã®ã‚ˆã†ã«ã€å®šç¾©ã¨å‚ç…§ã‚’ã¾ã¨ã‚ã¦å‡ºã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
`{ includeDeclaration = false }` ã‚’å…¥ã‚Œã¦ãŠãã¨ lsp_references ã‹ã‚‰å®šç¾©ä½ç½®ãŒé™¤å¤–ã•ã‚Œã‚‹ã®ã§ã€ãƒ€ãƒ–ã‚ŠãŒãªããªã‚Šè¦‹ã‚„ã™ã„ã§ã™ã€‚

```lua
---@param word string
---@param color string
---@return Source
local function separator(word, color)
local hlGroup = "DduDummy" .. color:gsub("[^a-zA-Z0-9]", "")
vim.api.nvim_set_hl(0, hlGroup, { fg = color })
return {
  "dummy",
  params = { word = word, hlGroup = hlGroup },
}
end

helper.register("lsp_finder", function()
helper.start("lsp:dummy", {
  separator(">>Definition<<", "#fc514e"),
  "lsp_definition",
  separator(">>References<<", "#5e97ec"),
  { "lsp_references", params = { includeDeclaration = false } },
})
end)
```

ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/9da0a1cf1ce2-20230621.png)

helper ã®å®Ÿä½“ã¯ã“ã“ã«ã‚ã‚Šã¾ã™ã€‚
https://github.com/uga-rosa/dotfiles/blob/main/nvim/lua/rc/helper/ddu.lua

# ãŠã‚ã‚Šã«

source ã‚„ filter ã‚’è‡ªç”±ã«çµ„ã¿æ›¿ãˆã‚‰ã‚Œã‚‹ã€ddu ã®è‰¯ã•ãŒå…‰ã‚‹è¨­å®šã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
è¦–è¦šçš„ãªã‚ã‹ã‚Šã‚„ã™ã•ã¯ã€ä½¿ã„å‹æ‰‹ã«å½±éŸ¿ã™ã‚‹é‡è¦ãªè¦ç´ ã§ã™ã€‚ãŠã—ã‚ƒã‚Œãªã ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã©ã‚“ã©ã‚“ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã—ã‚‡ã†ï¼

# è¬è¾

ã“ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ vim-jp slack ã§ [@kamecha](https://zenn.dev/kamecha) ã•ã‚“ã‹ã‚‰ãŠå€Ÿã‚Šã—ã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/0cde20edbfe4-20230621.png)
