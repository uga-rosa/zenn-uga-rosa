---
title: "vusted & nvim-kitã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Neovim", "Lua"]
published: true
published_at: 2023-04-07 07:00
---

# ã¯ã˜ã‚ã«

ã“ã‚Œã¯ [Vimé§…ä¼](https://vim-jp.org/ekiden/) 4/7ã®è¨˜äº‹ã§ã™ã€‚

ã¿ãªã•ã‚“ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œã£ã¦ã¾ã™ã‹ï¼Ÿ
ãƒ†ã‚¹ãƒˆã€æ›¸ã„ã¦ã¾ã™ã‹ï¼Ÿ

ä»Šå›ã¯ Neovim Lua ã§ã®ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ã€ç°¡å˜ã«è§¦ã‚Œã‚ˆã†ã‹ã¨æ€ã„ã¾ã™ã€‚

# vusted (busted)

Vim ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ããªã‚‰ [vim-themis](https://github.com/thinca/vim-themis) ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚

ã§ã™ãŒã€Lua ã§æ›¸ã„ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ†ã‚¹ãƒˆã‚‚ Lua ã§æ›¸ããŸã„ã§ã™ã‚ˆã­ã€‚
ãã“ã§ [vusted](https://github.com/notomo/vusted) ãŒä¾¿åˆ©ã§ã™ã€‚

ä½œè€…æœ¬äººã®ç´¹ä»‹è¨˜äº‹ã¯[ã“ã¡ã‚‰](https://zenn.dev/notomo/articles/neovim-lua-plugin-testing)

[busted](https://github.com/lunarmodules/busted) ã‚’ `nvim --headless` ã§ãƒ©ãƒƒãƒ—ã—ãŸã‚‚ã®ã§ã€CIã§ã‚‚å‹•ã‹ã›ã¾ã™ã€‚
[å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://lunarmodules.github.io/busted/)ã®ä»–ã€æ—¥æœ¬èªè¨˜äº‹ã‚‚å¹¾ã¤ã‹ã‚ã‚Šã¾ã™ã®ã§ busted ã®ä½¿ã„æ–¹ã¯çœç•¥ã—ã¾ã™ã€‚
å¤§ä½“ JavaScript ã® mocha ã§ã™ã€‚

```lua
describe("foo", function()
  it("bar", function()
    local bar = "bar"
    assert.are.equals("bar", bar)
  end)

  it("baz", function()
    vim.api.nvim_buf_set_lines(0, 0, -1, true, { "baz" })
    assert.are.equals("baz", vim.api.nvim_get_current_line())
  end)
end)
```

# nvim-kit

https://github.com/hrsh7th/nvim-kit

nvim-kit ã¯ã€åŸ‹ã‚è¾¼ã¿å‹ã® Lua utilities ã§ã™ã€‚
`:KitInstall` ã§è‡ªèº«ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«è¿½åŠ ã§ãã¾ã™ã€‚

ã“ã‚Œã¯ç§ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ [ccc.nvim](https://github.com/uga-rosa/ccc.nvim) ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ä¸€éƒ¨ã§ã™ã€‚

```sh
ï„• lua
â””â”€â”€ ï„• ccc
   â”œâ”€â”€ ï„• kit
   â”‚  â”œâ”€â”€ ï„• App
   â”‚  â”œâ”€â”€ ï„• Async
   â”‚  â”œâ”€â”€ î˜  init.lua
   â”‚  â”œâ”€â”€ ï„• IO
   â”‚  â”œâ”€â”€ ï„• LSP
   â”‚  â”œâ”€â”€ ï„• Thread
   â”‚  â””â”€â”€ ï„• Vim
```

è‰²ã€…ã¨ä¾¿åˆ©ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚
vusted ã§ãƒ†ã‚¹ãƒˆãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€ä½¿ã„æ–¹ã¯ãã¡ã‚‰ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

ä»Šå›ä½¿ã†ã®ã¯ `Vim.Keymap` ã§ã™ã€‚
`feedkeys()` ã«ã‚ˆã‚‹ã‚­ãƒ¼å…¥åŠ›ã¯è‰²ã€…ã¨åµŒã‚Šã©ã“ã‚ãŒå¤šãã€ãã®ã¾ã¾ä½¿ã†ã®ã¯å¤§å¤‰ã§ã™ã€‚
ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€éåŒæœŸã€åŒæœŸã§ã®å…¥åŠ›ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

# ä½¿ã„æ–¹

ã‚­ãƒ¼å…¥åŠ›ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«ã¯ `Keymap.send()` ã‚’ä½¿ã„ã¾ã™ã€‚
ãã®ã¾ã¾ä½¿ã†ã¨éåŒæœŸã«ãªã‚‹ã®ã§ã€åŒæœŸã•ã›ãŸã„å ´åˆã¯ `:await()` ã‚’ä»˜ã‘ã¾ã™ã€‚
ã¾ãŸãƒ†ã‚¹ãƒˆã§ä½¿ã†ã¨ãã¯ã€`Keymap.spec()` ã®ä¸­ã§ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

æ¸¡ã™æ–‡å­—åˆ—ã¯ãã®ã¾ã¾è§£é‡ˆã•ã‚Œã‚‹ã®ã§ã€ç‰¹æ®Šãªã‚­ãƒ¼ã‚’é€ä¿¡ã—ãŸã„ã¨ãã¯ `Keymap.termcodes()` ã‚’æŒŸã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã¾ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ remap ã•ã‚Œã¾ã›ã‚“ã€‚remap ã•ã›ãŸã„æ™‚ã¯å¼•æ•°ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã—ã¾ã™ã€‚
å¼•æ•°ã«ã¯ã€ãã‚Œã‚‰ã®é…åˆ—ã‚’å–ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
nvim-kit ã¯å…¨ã¦ annotation ãŒã¤ã„ã¦ã¾ã™ã®ã§ã€å›°ã£ãŸã‚‰å‹ã‚’è¦‹ã¾ã—ã‚‡ã†ã€‚

- keymap_spec.lua
```lua
vim.opt.runtimepath:append("/path/to/nvim-kit")

local Keymap = require("___kit___.kit.Vim.Keymap")
local t = Keymap.termcodes
local Async = require('___kit___.kit.Async')

describe("Keymap", function()
  before_each(function()
    vim.cmd("enew!")
  end)

  it("insert", function()
    Keymap.spec(function()
      Keymap.send(t("ifoo<Esc>")):await()
      assert.are.equals("foo", vim.api.nvim_get_current_line())
    end)
  end)

  it("remap", function()
    Keymap.spec(function()
      vim.keymap.set("i", "jj", "<Esc>")
      Keymap.send({ keys = "ifoojj", remap = true }):await()
      assert.are.equals("foo", vim.api.nvim_get_current_line())
    end)
  end)

  it('should send multiple keys in sequence', function()
    vim.keymap.set(
      'i',
      '(',
      Async.async(function()
        Keymap.send('('):await()
        assert.equals('[(', vim.api.nvim_get_current_line())

        Keymap.send(')'):await()
        assert.equals('[()', vim.api.nvim_get_current_line())

        Keymap.send(t('<Left>a<Right>')):await()
        assert.equals('[(a)', vim.api.nvim_get_current_line())
      end)
    )
    Keymap.spec(function()
      Keymap.send('i'):await()
      Keymap.send({ '[', { keys = '(', remap = true }, ']' }):await()
      assert.equals('[(a)]', vim.api.nvim_get_current_line())
    end)
  end)
end)
```

3ã¤ç›®ã®ãƒ†ã‚¹ãƒˆã¯æœ¬å®¶ã® Keymap_spec.lua ã‹ã‚‰æŒã£ã¦ãã¾ã—ãŸã€‚
`Keymap.send():await()` ã¯ã€è¤‡é›‘ãªå…¥åŠ›ã§ã‚‚ãã¡ã‚“ã¨åŒæœŸçš„ã«å‡¦ç†ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

ã¾ãŸ `Keymap.spec()` ã‹ã‚‰æŠœã‘ã‚‹ã¨ insert mode ã‹ã‚‰ normal mode ã«è‡ªå‹•ã§æˆ»ã•ã‚Œã¾ã™ã€‚
ãªã®ã§ã€ä¸€ã¤ã‚ã®ãƒ†ã‚¹ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ã‚‚ã€ãã‚Œä»¥é™ã®ãƒ†ã‚¹ãƒˆã¯ã¡ã‚ƒã‚“ã¨é€šã‚Šã¾ã™ã€‚

```lua
    Keymap.spec(function()
      Keymap.send("ifoo"):await()
      assert.are.equals("foo", vim.api.nvim_get_current_line())
    end)
```

# çµ‚ã‚ã‚Šã«

ã“ã‚Œã§ã‚³ãƒãƒ³ãƒ‰ã‚„ãƒãƒƒãƒ”ãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆãŒç°¡å˜ã«æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ä½œè€…ã®ãŠäºŒäººã«ã¯è¶³ã‚’å‘ã‘ã¦å¯ã‚Œã¾ã›ã‚“ ğŸ™
