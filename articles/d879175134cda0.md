---
title: "ãˆã£ï¼Nimã§Neovimç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ï¼ï¼Ÿ"
emoji: "ğŸ‘‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['Neovim', 'Lua', "Nim"]
published: true
---

ã“ã®è¨˜äº‹ã¯ [Vim Advent Calendar 2022](https://qiita.com/advent-calendar/2022/vim) ã®18æ—¥ç›®ã§ã™ã€‚

# ãˆã£ï¼Nimã§Neovimç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ï¼ï¼Ÿ

ã§ãã‚‰ãï¼

ã¯ã„ã€‚ã¨ã„ã†ã“ã¨ã§ä»•çµ„ã¿ã‹ã‚‰é †ã«è©±ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

Nim langã«ã¤ã„ã¦ã¯ç‰¹ã«è§£èª¬ã—ã¾ã›ã‚“ã€‚
ã©ã¡ã‚‰ã‹ã¨ã„ã†ã¨LuaJITã®FFIã«æ³¨ç›®ã—ãŸè©±ã§ã€Goã‚„Rustãªã©ã®ä»–ã®è¨€èªã«ã‚‚å¿œç”¨ã§ãã‚‹ã¯ãšã§ã™ã€‚

ä¾‹ã¨ã—ã¦ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ã„ã¾ã™ã€‚
https://github.com/uga-rosa/nim-example.nvim
ã‚¢ãƒƒã‚«ãƒ¼ãƒãƒ³é–¢æ•°ã‚’è¨ˆç®—ã™ã‚‹ã ã‘ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã™ã€‚
ã‚„ã‚Šã™ãã‚‹ã¨Neovimã”ã¨è½ã¡ã‚‹ã®ã§ãŠæ°—ã‚’ä»˜ã‘ãã ã•ã„ã€‚

# FFI Library

Neovimã®Lua runtimeã¯LuaJITã§ã™ã€‚
LuaJITã¯åŸºæœ¬çš„ã«ã¯Lua5.1äº’æ›ã§ã‚ã‚Šã€ãã®æ‰±ã„ã§å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã—ã‹ã—LuaJITå›ºæœ‰ã®æ©Ÿèƒ½ã¨ã„ã†ã®ã‚‚å¹¾ã¤ã‹ã‚ã‚Šã¾ã™ã€‚
ä»Šå›å–ã‚Šä¸Šã’ã‚‹[FFI Library](https://luajit.org/ext_ffi.html)ã¯ãã®ä¸€ã¤ã§ã™ã€‚

FFIã¨ã¯Foreign Function Interfaceã®ç•¥ã§ã‚ã‚Šã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªé–“ã®é€£æºã‚’è¡Œã†ãŸã‚ã®æ©Ÿèƒ½ã§ã™ã€‚
LuaJITã®FFIã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¯Cè¨€èªã§ã™ã€‚

# Nimã˜ã‚ƒãªã„ã‚„ã‚“

ã¯ã„ã€‚ãƒ€ãƒ¡ã˜ã‚ƒã‚“ã¨æ€ã„ã¾ã™ã‚ˆã­ã€‚
å®Ÿã¯Nimã¯ãƒˆãƒ©ãƒ³ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãªã®ã§ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Nim -> C -> binaryã®éç¨‹ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã„ã¾ã™ã€‚
ã¤ã¾ã‚Šã€ç†è«–ä¸Šã¯Nimã§å®šç¾©ã—ãŸé–¢æ•°ã‚’LuaJITã‹ã‚‰ä½¿ãˆã‚‹ã¯ãšã§ã™ã€‚

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã¯javascriptã‚‚ä½¿ãˆã‚‹ã‚‰ã—ã„ã®ã§ã™ãŒã€Vim/Neovimã§ãã£ã¡ã‚’ä½¿ã„ãŸã„ã®ãªã‚‰ã°ç´ ç›´ã«[denops.vim](https://github.com/vim-denops/denops.vim)ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚
ã‚ãˆã¦Nimã§æ›¸ã‹ãªãã¨ã‚‚ãã®ã¾ã¾ã§æ›¸ãã‚„ã™ã„è¨€èªã§ã™ã—ã­ã€‚

# FFI libraryã‚’ä½¿ã†ã«ã¯

ã¨ã‚Šã‚ãˆãš[å…¬å¼](https://luajit.org/ext_ffi.html)ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
è‹±èªã§ã™ãŒä¾‹ã‚’å¤šã‚ã«è¼‰ã›ã¦ãã‚Œã¦ã„ã‚‹ã®ã§èª­ã¿ã‚„ã™ã„ã‹ã¨æ€ã„ã¾ã™ã€‚

ã©ã†ã‚„ã‚‰ã€Cã®å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆ*.so/dllï¼‰ã‹ã‚‰èª­ã¿è¾¼ã‚€å½¢ã§ç”¨ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
ã¨ã„ã†ã“ã¨ã§ã€Nimã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹æ–¹æ³•ã‚’èª¿ã¹ã¦ã¿ã¾ã™ã€‚

# ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

Nimã¯å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ã®ãŒä¸€ç•ªæ­£ç¢ºã§æ‰‹ã£å–ã‚Šæ—©ã„ã§ã™ã€‚
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ãƒšãƒ¼ã‚¸ã¯[ã“ã“](https://nim-lang.org/docs/nimc.html)ã§ã™ã­ã€‚
ä»¥ä¸‹ã®è¨˜è¿°ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚

```
--app:console|gui|lib|staticlib
            generate a console app|GUI app|DLL|static library
```

ã¤ã¾ã‚Šã€æ¬¡ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚Œã°ã„ã„ã‚ˆã†ã§ã™ã€‚

```sh
nim c --app:lib path/to/foo.nim
```

nim-example.nvimã§ã¯[ã“ã‚“ãªæ„Ÿã˜](https://github.com/uga-rosa/nim-example.nvim/blob/main/Makefile)ã®Makefileã‚’æ›¸ãã¾ã—ãŸã€‚

# Nimã®ã‚³ãƒ¼ãƒ‰

ã•ã¦ã€Nimå´ã§ã‚‚ã†ä¸€ã¤ã‚„ã£ã¦ãŠã‹ãªã„ã¨ã„ã‘ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

è‚å¿ƒã®Nimã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯[ã“ã¡ã‚‰](https://github.com/uga-rosa/nim-example.nvim/blob/main/src/example.nim)ã«ãªã‚‹ã®ã§ã™ãŒã€é–¢æ•°å®šç¾©ã®æœ€å¾Œã«ãªã«ã‹ä»˜ã„ã¦ã„ã¾ã™ã‚ˆã­ã€‚

```nim
1|  proc ackermann*(m, n: int): int {.exportc, dynlib.} =
```

ã“ã® `{}` ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ã¯ãƒ—ãƒ©ã‚°ãƒ(pragmas)ã¨ã„ã†ã‚‚ã®ã§ã€Nimã®å¼·åŠ›ãªè¨€èªæ©Ÿèƒ½ã®ä¸€ã¤ã§ã™ã€‚

> Pragmas are Nim's method to give the compiler additional information / commands without introducing a massive number of new keywords. Pragmas are processed on the fly during semantic checking. Pragmas are enclosed in the special {. and .} curly brackets. Pragmas are also often used as a first implementation to play with a language feature before a nicer syntax to access the feature becomes available.
https://nim-lang.org/docs/manual.html#pragmas

ä»Šå›ä½¿ã£ã¦ã„ã‚‹ãƒ—ãƒ©ã‚°ãƒã¯ä»¥ä¸‹ã®äºŒã¤ã§ã€ï¼ˆä»Šå›ã®ç”¨é€”ã§ã¯ï¼‰ã‚»ãƒƒãƒˆã§ç”¨ã„ã‚‹ã‚‚ã®ã§ã™ã€‚
[exportc pragmas](https://nim-lang.org/docs/manual.html#foreign-function-interface-exportc-pragma)
[dynlib pragmas for export](https://nim-lang.org/docs/manual.html#foreign-function-interface-dynlib-pragma-for-export)

ã“ã‚Œã‚‰ã®ãƒ—ãƒ©ã‚°ãƒã‚’ä»˜ã‘ãªã„ã¨ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ããªã„ã®ã§æ°—ã‚’ä»˜ã‘ã¾ã—ã‚‡ã†ã€‚

# Luaã‹ã‚‰èª­ã¿è¾¼ã‚€

ã“ã‚Œã§æº–å‚™ã¯æ•´ã„ã¾ã—ãŸã€‚
nim-example.nvimã§ã¯ã€makeã«ã‚ˆã£ã¦`./build/libex.(so|dll)`ãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œã¦ã¾ã™ã€‚

ã“ã‚Œã‚’LuaJITã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ã¿ã¾ã—ã‚‡ã†ã€‚
[ã“ã¡ã‚‰](https://github.com/uga-rosa/nim-example.nvim/blob/main/lua/nim-example/init.lua)ã®èª¬æ˜ã¨ã„ã†å½¢ã§ä½¿ã„æ–¹ã‚’ç°¡å˜ã«èª¬æ˜ã—ã¾ã™ã€‚

```lua
local uv = vim.loop
local fn = vim.fn

local ffi = require("ffi")

-- çµ¶å¯¾ãƒ‘ã‚¹ã®ç”Ÿæˆãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿
-- ffi.load()ã¯çµ¶å¯¾ãƒ‘ã‚¹ã§ãªã„ã¨ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜ã®æ–¹æ³•ã§è§£æ±ºã™ã‚‹ã®ã§ã€ä»Šå›ã®ç”¨é€”ã«ã¯é©ã•ãªã„ã€‚
local this_file_path = uv.fs_realpath(debug.getinfo(1, "S").source:sub(2))
local root_path = fn.fnamemodify(this_file_path, ":h:h:h")
local lib_path
if ffi.os == "Windows" then
  lib_path = fn.expand(root_path .. "/build/libex.dll")
else
  lib_path = fn.expand(root_path .. "/build/libex.so")
end

local libex = ffi.load(lib_path)

-- Cã§ã®å®šç¾©ã€‚ã“ã“ã§æ›¸ã„ãŸã‚‚ã®ã—ã‹ä½¿ãˆãªã„ã€‚
ffi.cdef([[
int ackermann(int m, int n);
]])

local M = {}

function M.nim_ackermann(m, n)
  -- libexã¯ffi.load()ã®æˆ»ã‚Šå€¤
  return libex.ackermann(m, n)
end

-- æ¯”è¼ƒç”¨ã®pure lua version
local function ackermann(m, n)
  if m == 0 then
    return n + 1
  elseif n == 0 then
    return ackermann(m-1, 1)
  else
    return ackermann(m-1, ackermann(m, n-1))
  end
end

function M.lua_ackermann(m, n)
  return ackermann(m, n)
end

return M
```

ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦èª¬æ˜ã‚’å…¥ã‚Œã¾ã—ãŸã€‚
å…¨ä½“ã®æµã‚Œã¨ã—ã¦ã¯

1. `ffi.load()`ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚€ã€‚
2. `ffi.cdef()`ã§ä½¿ã„ãŸã„é–¢æ•°ã®å®šç¾©ã‚’æ›¸ãã€‚
3. `ffi.load()`ã®æˆ»ã‚Šå€¤ã‚’ä»‹ã—ã¦ãã®é–¢æ•°ã‚’ä½¿ã†ã€‚

ã¨ã„ã£ãŸæ„Ÿã˜ã§ã™ã€‚

[å…¬å¼ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://luajit.org/ext_ffi_tutorial.html)ã‚‚å‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

# æ¯”è¼ƒ

ã§ã¯æœ€å¾Œã«ã€Nim versionã¨Lua versionã®ã‚¢ãƒƒã‚«ãƒ¼ãƒãƒ³é–¢æ•°ã®é€Ÿåº¦ã‚’æ¯”è¼ƒã—ã¦ã¿ã¦çµ‚ã‚ã‚Šã«ã—ã¾ã—ã‚‡ã†ã€‚

```vim
:NimAckermann 3 10
" -> 8189
" -> time: 41.04 ms
:LuaAckermann 3 10
" -> 8189
" -> time: 106.195 ms
```

Nimã®æ–¹ãŒå€ä»¥ä¸Šé€Ÿã„ã§ã™ã­ï¼
......
å€ã¡ã‚‡ã£ã¨ç¨‹åº¦ã§æ¸ˆã‚€LuaJITã®é€Ÿåº¦ãŒç•°å¸¸ã ã¨ã„ã†ã‚ªãƒã§ã—ãŸã€‚ãƒãƒ£ãƒ³ãƒãƒ£ãƒ³ã€‚

# ãŠã¾ã‘

æœ€æ–°ã®Lua5.4.3ã§ã‚‚æ¯”è¼ƒã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```lua:ackermann.lua
local function ackermann(m, n)
  if m == 0 then
    return n + 1
  elseif n == 0 then
    return ackermann(m-1, 1)
  else
    return ackermann(m-1, ackermann(m, n-1))
  end
end

local start = os.clock()
print(ackermann(3, 10))
print("time:", (os.clock() - start) * 1000, "ms")
```

```sh
$ lua ackermann.lua
8189
time:   702.039 ms
```

LuaJITã®6å€ä»¥ä¸Šã®æ™‚é–“ã«ãªã‚Šã¾ã—ãŸã€‚
ã‚ªãƒªã‚¸ãƒŠãƒ«ã®Luaã‚‚ã‹ãªã‚Šæ—©ããªã£ã¦ã„ã¾ã™ãŒã€ã¾ã LuaJITã®æ–¹ãŒæ—©ã„ã§ã™ã­ã€‚
