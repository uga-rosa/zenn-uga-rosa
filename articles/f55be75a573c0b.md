---
title: "ddu.vimにちゃんと入門した話"
emoji: "🐈"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Neovim", "denops"]
published: true
published_at: 2023-05-29 00:00
---

# はじめに

Vim/Neovim 用ファジーファインダー（FF）である、ddu.vim にちゃんと入門しました。
せっかくなのでその備忘録と、どういう人に向いていそうかなどを適当に書いてみます。

ddu.vim 自体の説明はあまりしません。
作者の記事があるのでこちらをどうぞ。

https://zenn.dev/shougo/articles/ddu-vim-beta

# 結論

ライトユーザーにはオススメできません。
全ての挙動を制御したい。設定したようにしか動かないでほしい。
そのための設定やバグ修正、存在しないモジュールの自作などのコストを払える人にとっては素晴しい FF です。

ddu.vim に手を出すのは、telescope.nvim や fzf-lua などのオールインワン系の FF を使ってみて、もっとカスタマイズしたいと思ってからでいいと思います。
あれらは多大な労力で多くの機能がプリインストールされており、作者の想定を逸脱しない範囲で使う分には素晴しいプラグインです。

私は導入して2週間ほどですが、色々と直したり新しく作ったりする羽目になりました。

https://github.com/yuki-yano/ddu-filter-fzf
https://github.com/gamoutatsumi/ddu-source-nvim-lsp
https://github.com/uga-rosa/ddu-source-search_history
https://github.com/uga-rosa/ddu-filter-converter_devicon
https://github.com/uga-rosa/ddu-filter-sorter_length

本体や ui-ff へのバグ報告も、(vim-jpで) 何件も行いました。

おそらく私が特殊な使い方をしているせいなので、ここまで大変な移行になる可能性は低いですが。。。

ddu-source-nvim-lsp に関してなのですが、一応 references ソースは直しました。
しかし、Neovim 側の仕様と一部の LS の仕様が悪魔的に噛み合っているせいで、なかなか面倒なことになっています。
設計からやり直した方がよさそうなので、この記事を書いたら取りかかる予定です。

# 設定

https://github.com/uga-rosa/dotfiles/blob/30731f78ec8b1f5cc05fe7cc45c7c157a458048b/nvim/rc/ddu.toml
https://github.com/uga-rosa/dotfiles/blob/30731f78ec8b1f5cc05fe7cc45c7c157a458048b/nvim/lua/rc/ddu.lua

dotfiles は公開しているので、実際の設定はリンクとして丸ごと貼っておきます。
このあたりを見れば ddu 関連の設定は大体あると思います。

## 私の設定の特徴

ddu.vim は本来、通常の Vim バッファ同様にノーマルモードで操作することを想定しています。

しかし私の使い方は
- 絞り込みを多用
- ファイルを開く以外のアクションはほとんど使わない

であるため、他の FF 同様に filter window の insert mode からの操作を主軸とした方が効率的です。
最初から filter に入るようにし（`startFilter` を有効化）、fzf で候補を絞った後に（カーソルを動かしても数行）そのまま filter からファイルを開く、というワークフローに合わせてマッピングしました。
一部のアクションは insert mode から呼ぶと壊れるので、文字列で `<Esc>` からマッピングしなければいけません。

また、新規タブでファイルを開くときに `:tcd` を走らせるようにしています。

```lua
vim.api.nvim_create_autocmd("FileType", {
  pattern = "ddu-ff",
  callback = function()
    -- Highlight cursor line
    vim.opt_local.cursorline = true
    -- Close UI
    map("n", "<Esc>", ddu.call_action("quit"))
    -- Open file
    map("n", "<CR>", ddu.itemAction("default"))
    map("n", "<C-x>", ddu.itemAction("open", { command = "split" }))
    map("n", "<C-v>", ddu.itemAction("open", { command = "vsplit" }))
    map("n", "<C-t>", ddu.open_tab)
    -- Enter filter
    map("n", "i", ddu.call_action("openFilterWindow"))
  end,
})

vim.api.nvim_create_autocmd("FileType", {
  pattern = "ddu-ff-filter",
  callback = function()
    -- Close UI
    map("i", "<C-c>", "<Esc><Cmd>call ddu#ui#do_action('quit')<CR>")
    map("n", "<Esc>", ddu.call_action("quit"))
    -- Close filter window
    -- Lexima overwrite <Esc> mapping
    vim.b.lexima_disabled = true
    map("i", "<Esc>", "<Esc><Cmd>call ddu#ui#do_action('closeFilterWindow')<CR>")
    -- Open file
    map("i", "<CR>", ddu.itemAction("default"))
    map("i", "<C-x>", ddu.itemAction("open", { command = "split" }))
    map("i", "<C-v>", ddu.itemAction("open", { command = "vsplit" }))
    map("i", "<C-t>", ddu.open_tab)
    -- Move cursor
    map("i", "<C-n>", ddu.execute("normal! j"))
    map("i", "<C-p>", ddu.execute("normal! k"))
    -- Emacs like keymapping
    map("i", "<C-a>", "<Home>")
    map("i", "<C-e>", "<End>")
  end,
})
```

また、UI 本体もプレビューを floating window で出すようにし、サイズや位置も調整しました。
これは見た目の好みです。

また、各種呼び出しをサブコマンドとして登録する方式にしています。
これは toml でソースごとの設定を分割するためです。
`require()` をハックする `package.preload` を使ったりして（無駄に）テクニカルなので、気になる人は読んでみてください。
ちゃんと補完にも対応しています。

![cmdline-complete](https://storage.googleapis.com/zenn-user-upload/d8f33770bc40-20230528.png)

# おわりに

この記事を読んで、「へへっ、面白そうじゃねえか」と思える人にはとても向いていると思います。
深い沼に一緒に沈みましょう。。。
