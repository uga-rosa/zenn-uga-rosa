---
title: "SKKå®Ÿè£…å…¥é–€ (1) ãƒ­ãƒ¼ãƒå­— -> ã²ã‚‰ãŒãªå¤‰æ›"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ime", "skk", "Neovim", "Lua"]
published: true
---

ç¬¬ä¸€å› ã“ã®è¨˜äº‹
[æ¬¡å›](https://zenn.dev/uga_rosa/articles/e4c532a59de7d6)

# ã¯ã˜ã‚ã«

æ—¥æœ¬èªè©±è€…ã«ã¨ã£ã¦ã€IME ã¯ç”Ÿæ´»ã«ã‹ã‹ã›ãªã„ã‚‚ã®ã§ã—ã‚‡ã†ã€‚
ã—ã‹ã—ã€ãã®ä»•çµ„ã¿ã«ã¤ã„ã¦è€ƒãˆãŸã“ã¨ãŒã‚ã‚‹äººã¯æ„å¤–ã¨å°‘ãªã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã“ã®é€£è¼‰ã§ã¯ã€çš†ã•ã‚“ã”å­˜ã˜ã® IME ã§ã‚ã‚‹ skk ã‚’ Neovim ä¸Šã§å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
ï¼ˆã”å­˜ã˜ãªã„æ–¹ã¯[ã“ã¡ã‚‰](https://dic.nicovideo.jp/t/a/skk)ãŒ~~æ„å¤–ã¨~~è©³ã—ã„ã®ã§ã©ã†ãï¼‰

ä¸»ã«å‚è€ƒã«ã™ã‚‹ã®ã¯ã“ã¡ã‚‰ã§ã™ã€‚æœ€æ–°ã®skkå®Ÿè£… (in Vim) ã§ã€TypeScript ã§è¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://github.com/vim-skk/skkeleton
ã“ã®è¨˜äº‹ã‚‚ skkeleton ã‚’ä½¿ã£ã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚

ç¬¬ä¸€å›ã§ã¯ã€ãƒ­ãƒ¼ãƒå­—ã‚’ã²ã‚‰ãŒãªã«å¤‰æ›ã™ã‚‹ä»•çµ„ã¿ã‚’ä½œã‚Šã¾ã™ã€‚
SKK å›ºæœ‰ã®è©±ã¯ã¾ã ã§ã™ãŒã€æ˜¯éãŠæ¥½ã—ã¿ä¸‹ã•ã„ã€‚

# å…è²¬äº‹é …

- ã“ã®é€£è¼‰ã®ç›®çš„ã¯ä»•çµ„ã¿ã®ç†è§£ã§ã™ã€‚
  - å®Ÿç”¨çš„ãªã‚‚ã®ã‚’ä½œã‚‹ãŸã‚ã§ã¯ãªã„ã®ã§ã€ã‚ãã¾ã§å­¦ç¿’ç”¨ã¨ã—ã¦ã”è¦§ä¸‹ã•ã„ã€‚
  - ãªã‚‹ã¹ãç°¡æ½”ãªå®Ÿè£…ã«ãªã‚‹ã“ã¨ã‚’å„ªå…ˆã—ã¾ã™ã€‚
- ç­†è€…ã¯å°‚é–€å®¶ã§ã¯ãªã„ã®ã§ã€ã“ã‚ŒãŒæœ€é©ãªå®Ÿè£…ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚

# æŠ€è¡“é¸å®š

- Neovim
  - ç§ãŒå¥½ã
  - TUIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦ä¾¿åˆ©ã§ã™
- Lua
  - ä¾å­˜ç„¡ã—ã§ Neovim ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æ›¸ããªã‚‰ Vim script ã‹ Lua ã®äºŒæŠã§ã™
  - ç§ãŒæ…£ã‚Œã¦ã„ã‚‹ã®ã¨ã€è¨€èªä»•æ§˜ãŒéå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ã„ã®ã§ã“ã¡ã‚‰ã‚’æ¡ç”¨

Neovim Lua å›ºæœ‰ã®è©±ã‚’çŸ¥ã‚ŠãŸã„å ´åˆã¯[ã“ã‚Œ](https://github.com/willelz/nvim-lua-guide-ja/blob/master/README.ja.md)ã‚’èª­ã¿ã¾ã—ã‚‡ã†ã€‚
Lua è‡ªä½“ã®å…¥é–€è¨˜äº‹ã‚‚å…ˆé ­ã«å¹¾ã¤ã‹è¼‰ã£ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€å‹æƒ…å ±ã‚’ Language Server ã«æ¸¡ã™ãŸã‚ LuaLS ã® annotations ã‚’ç”¨ã„ã¾ã™ã€‚
https://github.com/LuaLS/lua-language-server/wiki/Annotations

# ãƒªãƒã‚¸ãƒˆãƒª

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½¿ã„ã¾ã™ã€‚
https://github.com/uga-rosa/skk-learning.nvim

ã“ã®è¨˜äº‹æ™‚ç‚¹ã®é€²æ—ã‚³ãƒŸãƒƒãƒˆã¯ã“ã¡ã‚‰ã€‚
https://github.com/uga-rosa/skk-learning.nvim/tree/2dd341c1d33bf13b1fdf667582e32588659a3c7b

# ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

- å…¥åŠ›ã¯ä¸€æ–‡å­—ãšã¤æ¸¡ã•ã‚Œã¾ã™ã€‚
  - ãã‚Œã¾ã§ã®å…¥åŠ›ã‚’è¦šãˆã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã®ã§ã€`Context` ã‚¯ãƒ©ã‚¹ã‚’å°å…¥ã—ã¾ã™ã€‚
- `KanaTable` ã¯å¤‰æ›ãƒ«ãƒ¼ãƒ«ã§ã™ã€‚
  - å‹ã¯ `{ input: string, output: string, next: string }[]` ã¨ã—ã¾ã™ã€‚
  - Google æ—¥æœ¬èªå…¥åŠ›ã§ã„ã†ã€ã€Œå…¥åŠ›ã€ã€Œå‡ºåŠ›ã€ã€Œæ¬¡ã®å…¥åŠ›ã€ã‹ã‚‰ãªã‚‹ table ã‚’è¦ç´ ã¨ã™ã‚‹é…åˆ—ã§ã™ã€‚
  - `bb -> ã£b` ã‚„ `bba -> ã£ã°` ãŒç°¡å˜ã«å®Ÿç¾ã§ãã¾ã™ã€‚
![](/images/google_ime_settings.png)
- æ¬¡ã®å…¥åŠ›ã‚’è¦‹ãªã„ã¨å¤‰æ›å€™è£œãŒç¢ºå®šã§ããªã„ã‚‚ã®ã«ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
  - `nn -> ã‚“` ã¨ `nm -> ã‚“m` ãªã©ã€‚
  - ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’åŒæ™‚ã«å°å…¥ã—ã¾ã™ã€‚
    - `{ input = "nn", output = "ã‚“", next = "" }`
    - `{ input = "n", output = "ã‚“", next = "" }`
  - å…¥åŠ›ã«å¯¾ã™ã‚‹å‰æ–¹ä¸€è‡´ã§å¤‰æ›ãƒ«ãƒ¼ãƒ«ã‚’çµã‚Šè¾¼ã¿ã¾ã™ã€‚
  - å€™è£œãŒä¸€ã¤ã‹ã¤å®Œå…¨ä¸€è‡´ã«ãªã£ãŸã‚‰å¤‰æ›ã‚’ç¢ºå®šã—ã¾ã™ã€‚
  - 0 å€‹ã«ãªã£ãŸå ´åˆã¯
    - ç›´å‰ã¾ã§ã®å…¥åŠ›ã«å®Œå…¨ä¸€è‡´ã™ã‚‹å€™è£œãŒã‚ã‚Œã°ã€ãã‚Œã‚’ç¢ºå®šã—æ–°ã—ã„å…¥åŠ›ã‚’ç©ã¿ã¾ã™ã€‚
    - ç„¡ã‘ã‚Œã°èª¤å…¥åŠ›ã§ã™

# å®Ÿè£…

- lua/skk/kana/kana_table.lua
  - å¤‰æ›ãƒ«ãƒ¼ãƒ«ã®å®šç¾©ã§ã™ã€‚
  - ç°¡å˜ã®ãŸã‚ `kanaRules` ã¯ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚
  - `kana` ã§åå‰ç©ºé–“ã‚’åˆ‡ã£ã¦ã„ã‚‹ã®ã¯ã€ã‚«ã‚¿ã‚«ãƒŠã‚„å…¨è§’è‹±æ•°ã¸ã®å¤‰æ›ã‚‚å¾Œã€…å®Ÿè£…ã™ã‚‹ãŸã‚ã§ã™ã€‚

```lua
---@class KanaRule
---@field input string
---@field output string
---@field next string

---@type KanaRule[]
local kanaRules = {
  { input = "-", output = "ãƒ¼", next = "" },
  { input = "~", output = "ã€œ", next = "" },
  { input = ".", output = "ã€‚", next = "" },
  -- ä»¥ä¸‹ç•¥
}

---@class KanaTable
---@field rules KanaRule[]
local KanaTable = {
  rules = kanaRules,
}

---@return KanaTable
function KanaTable.new()
  return setmetatable({}, { __index = KanaTable })
end

---inputã¨ã®å‰æ–¹ä¸€è‡´ã§çµã‚Šè¾¼ã‚€
---@param pre string
---@return KanaRule[]
function KanaTable:filter(pre)
  return vim.tbl_filter(function(rule)
    return vim.startswith(rule.input, pre)
  end, self.rules)
end

return KanaTable
```

- lua/skk/context.lua
  - å…¥åŠ›çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

```lua
local kanaTable = require("skk.kana.kana_table")

---@class Context
---@field kanaTable KanaTable å…¨ã¦ã®å¤‰æ›ãƒ«ãƒ¼ãƒ«
---@field fixed string ã‚‚ã†ç¢ºå®šã—ãŸã²ã‚‰ãŒãª
---@field feed string æœªç¢ºå®šã®ãƒ­ãƒ¼ãƒå­—
---@field tmpResult? KanaRule feedã«å®Œå…¨ä¸€è‡´ã™ã‚‹å¤‰æ›ãƒ«ãƒ¼ãƒ«
local Context = {}

function Context.new()
  local self = setmetatable({}, { __index = Context })
  self.kanaTable = kanaTable.new()
  self.fixed = ""
  self.feed = ""
  return self
end

---@param candidates? KanaRule[]
function Context:updateTmpResult(candidates)
  candidates = candidates or self.kanaTable:filter(self.feed)
  self.tmpResult = nil
  for _, candidate in ipairs(candidates) do
    if candidate.input == self.feed then
      self.tmpResult = candidate
      break
    end
  end
end

return Context
```

- lua/skk/input.lua
  - ãƒ­ãƒ¼ãƒå­—å…¥åŠ›ã‚’ã²ã‚‰ãŒãªã«å¤‰æ›ã—ã¾ã™ã€‚
  - ä»Šå›ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†ã§ã™ã€‚

```lua
local Input = {}

---@param context Context
---@param char string
function Input.kanaInput(context, char)
  local input = context.feed .. char
  local candidates = context.kanaTable:filter(input)
  if #candidates == 1 and candidates[1].input == input then
    -- å€™è£œãŒä¸€ã¤ã‹ã¤å®Œå…¨ä¸€è‡´ã€‚ç¢ºå®š
    context.fixed = context.fixed .. candidates[1].output
    context.feed = candidates[1].next
    context:updateTmpResult()
  elseif #candidates > 0 then
    -- æœªç¢ºå®š
    context.feed = input
    context:updateTmpResult(candidates)
  elseif context.tmpResult then
    -- æ–°ã—ã„å…¥åŠ›ã«ã‚ˆã‚ŠtmpResultã§ç¢ºå®š
    context.fixed = context.fixed .. context.tmpResult.output
    context.feed = context.tmpResult.next
    context:updateTmpResult()
    Input.kanaInput(context, char)
  else
    -- å…¥åŠ›ãƒŸã‚¹ã€‚context.tmpResultã¯æ—¢ã«nil
    context.feed = ""
    Input.kanaInput(context, char)
  end
end

return Input
```

# ãƒ†ã‚¹ãƒˆ

ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆãŒé€šã£ãŸã¨ã“ã‚ã§ç¬¬ä¸€å›ã¯çµ‚äº†ã¨ã—ã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã¯ [vusted](https://github.com/notomo/vusted) ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

- lua/skk/input_spec.lua

```lua
local Input = require("skk.input")
local Context = require("skk.context")

---@type Context
local context

---@param input string
---@param expect string
local function test(input, expect)
  for char in vim.gsplit(input, "") do
    Input.kanaInput(context, char)
  end
  assert.are.equals(expect, context.fixed)
end

describe("Tests for input.lua", function()
  before_each(function()
    context = Context.new()
  end)

  it("single char", function()
    test("ka", "ã‹")
  end)

  it("multiple chars (don't use tmpResult)", function()
    test("ohayou", "ãŠã¯ã‚ˆã†")
  end)

  it("multiple chars (use tmpResult)", function()
    test("amenbo", "ã‚ã‚ã‚“ã¼")
  end)

  it("multiple chars (use tmpResult and its next)", function()
    test("uwwwa", "ã†wã£ã‚")
  end)

  it("mistaken input", function()
    test("rkakyra", "ã‹ã‚‰")
  end)
end)
```

# æ¬¡å›äºˆå‘Š

ç¬¬äºŒå›ã§ã¯ã€å®Ÿéš›ã« Neovim ä¸Šã§ã²ã‚‰ãŒãªã‚’å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ãŠæ¥½ã—ã¿ã«ï¼
