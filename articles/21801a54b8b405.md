---
title: "dein.vim ã‚’ Neovim (Lua) ã§å¿«é©ã«ä½¿ã†"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Neovim, Lua]
published: false
---

# ã¯ã˜ã‚ã«

ç§ã¯ Neovim ãƒ¡ã‚¤ãƒ³ã§ Vim ã¯æ®†ã©ä½¿ã£ã¦ã„ã¾ã›ã‚“ã€‚
ã“ã®ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æµè¡Œã‚Šã«æ•æ„Ÿï¼ˆæ–°ã—ã„ã‚‚ã®å¥½ãï¼Ÿï¼‰ãªå‚¾å‘ãŒã‚ã‚‹ã‚ˆã†ã«æ€ã„ã¾ã™ã€‚
ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã ã¨ packer.nvimã€æœ€è¿‘ã ã¨ lazy.nvim ãŒäººæ°—ã§ã™ã‚ˆã­ã€‚

ç§ã‚‚ä»¥å‰ã¯ init.lua & packer.nvim ã‚’ä½¿ã£ã¦ã„ã¾ã—ãŸãŒã€ä»Šã¯ init.vim & dein.vim ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
ã§ã™ãŒä»Šã‚‚ Lua ã¯ãƒãƒªãƒãƒªä½¿ã£ã¦ã„ã¾ã™ï¼ˆä½œã£ã¦ã„ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ Lua è£½å¤šã‚ï¼‰ã€‚

ãã“ã§ä»Šå›ã¯ã€Lua ã‚’æ›¸ã Neovim ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŸã‚ã® dein.vim ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ç´¹ä»‹ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

# toml ã‚’ä½¿ã„ã“ãªã™

dein.vim ã‚’æ•¢ãˆã¦é¸ã¶ç†ç”±ã¨ãªã‚‹ã®ã¯ã€ã‚„ã¯ã‚Š toml ã§è¨­å®šã‚’æ›¸ã‘ã‚‹ç‚¹ã ã¨æ€ã„ã¾ã™ã€‚
ç§ã®è¨­å®šã‹ã‚‰ä¸€éƒ¨å¼•ç”¨ã—ã¾ã—ã‚‡ã†ã€‚

```toml
[[plugins]]
repo = 'yuki-yano/fuzzy-motion.vim'
depends = ['denops.vim', 'kensaku.vim']
on_cmd = 'FuzzyMotion'
hook_add = '''
    nnoremap ss <Cmd>FuzzyMotion<CR>
    let g:fuzzy_motion_matchers = ['fzf', 'kensaku']
'''
```

ã“ã®ã‚ˆã†ã«ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç®¡ç†ã¨ãã®è¨­å®šã‚’ã²ã¨ã¾ã¨ã‚ã«ã§ãã‚‹ã®ãŒä¾¿åˆ©ã§ã™ã‚ˆã­ã€‚

## hook_* ã¨ lua_*

ã¾ãšæ³¨ç›®ã—ãŸã„ã®ã¯ã€hook æ©Ÿèƒ½ã§ã™ã€‚
ã“ã‚Œã«ã¯3ç¨®é¡ã‚ã‚Šã¾ã—ã¦ã€`hook_add`, `hook_source`, `hook_post_source`ã§ã™ã€‚
ãã‚Œãã‚Œç°¡å˜ã«èª¬æ˜ã—ã¾ã™ã¨
- hook_add: èµ·å‹•æ™‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
- hook_source: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ç›´å‰ï¼ˆruntimepathã«è¿½åŠ ã•ã‚ŒãŸå¾Œï¼‰ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
- hook_post_source: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ã„ã‚„ã„ã‚„ã€ã“ã‚Œãã‚‰ã„ã¯çŸ¥ã£ã¦ã‚‹ã‚ˆã€ã¨æ€ã£ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ
å®Ÿã¯ã“ã‚Œã‚‰ã®ä»–ã«ã€`lua_*` ã¨ã„ã†ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ã€‚
`hook_*` ã®ãã‚Œãã‚Œã«å¯¾å¿œã—ã¦ã„ã¾ã—ã¦ã€`lua_add`, `lua_source`, `lua_post_source` ãŒã‚ã‚‹ã‚ã‘ã§ã™ã€‚
`hook_*` + `lua <<EOF` ã§ã‚‚æ›¸ã‘ã¾ã™ãŒï¼ˆå†…éƒ¨çš„ã«ã¯åŒã˜ï¼‰ã€ã‚¹ãƒãƒ¼ãƒˆã§å¬‰ã—ã„ã§ã™ã­ã€‚
ã¾ãŸã€ã“ã¡ã‚‰ã®æ–¹ãŒå¾Œè¿°ã™ã‚‹ foldexpr ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¨ç›¸æ€§ãŒè‰¯ã„ã§ã™ã€‚

ä½¿ç”¨ä¾‹ã§ã™ã€‚

```toml
[[plugins]]
repo = 'uga-rosa/ccc.nvim'
on_event = 'BufRead'
hook_add = '''
    nnoremap <C-c> <Cmd>CccPick<CR>
'''
lua_post_source = '''
    require("ccc").setup({
      default_color = "#40bfbf",
      bar_char = 'â–ˆ',
      point_char = '|',
      point_color = "#40bfbf",
      highlighter = {
        auto_enable = true,
        lsp = true,
      },
    })
'''
```

Lua ã¯ã€ç°¡å˜ãªè¨­å®šã‚’æ›¸ãä¸Šã§ã¯å†—é•·ã«ãªã‚Šã‚„ã™ã„ã§ã™ã€‚
dein.vim ãªã‚‰ã€æ‰‹è»½ã« Vim script ã¨ Lua ã®è‰¯ã„ã¨ã“å–ã‚ŠãŒã§ãã¾ã™ã€‚

## treesitterã§ç¶ºéº—ãª syntax highlight ã‚’

ã¿ãªã•ã‚“ã€treesitter ã¯ä½¿ã£ã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ã€‚
query ã‚’æ›¸ãã“ã¨ã§åŸ‹ã‚è¾¼ã¾ã‚ŒãŸåˆ¥è¨€èªã® syntax highlight ãŒå®Ÿç¾ã§ãã¾ã™ã€‚
è‡ªåˆ†ã§æ›¸ãã®ã¯å¤§å¤‰ã§ã—ã‚‡ã†ã‹ã‚‰ã€[ç§ã®ä½¿ã£ã¦ã„ã‚‹ query ãƒ•ã‚¡ã‚¤ãƒ«](https://github.com/uga-rosa/dotfiles/tree/main/nvim/after/queries/toml)ã‚’ç½®ã„ã¦ãŠãã¾ã™ã€‚
åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã«ã—ã¦ã€ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚

ç¶ºéº—ã§ã™ã­ã€‚

![](https://storage.googleapis.com/zenn-user-upload/7fb5103d854e-20230313.png)

## foldexpr ã§è¦‹ã‚„ã™ã

ã•ã¦ã€å‹˜ã®è‰¯ã„èª­è€…ã¯ã‚‚ã†æ°—ä»˜ã„ã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ã€‚
ã“ã“ã¾ã§ç§ãŒè²¼ã£ãŸ toml ã®è¨­å®šã¯ã€ä½•æ•…ã‹ `hook_*` ã‚„ `lua_*` ã®ä¸­èº«ãŒã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã•ã‚Œã¦ã„ã¾ã™ã­ã€‚

ã“ã‚Œã«ã¯ç†ç”±ãŒã‚ã‚Šã¾ã™ã€‚
ãã‚Œã¯ãšã°ã‚Šã€è‚¥å¤§åŒ–ã—ãŸè¨­å®šã‚’è‡ªå‹•ã§æŠ˜ã‚Šç•³ã‚€ãŸã‚ã§ã™ã€‚
ç§ã¯ dein.vim ã® ftplugin æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã€toml ã®æ™‚ã«ä»¥ä¸‹ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```vim
setl foldmethod=expr
setl foldexpr=<SID>fold_expr(v:lnum)

function! s:fold_expr(lnum) abort
  let line = getline(a:lnum)
  return line ==# '' || line[0:3] ==# '    '
endfunction
```

ã“ã®è¨­å®šã«ã‚ˆã‚Šã€å…¨ä½“ã®è¦‹é€šã—ãŒåŠ‡çš„ã«æ”¹å–„ã—ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/ae40b6a82a73-20230313.png)

## vim-partedit ã§ LSP ã®æ©æµã‚’å—ã‘ã‚‹

ã“ã“ã¾ã§ã¯è¦‹ãŸç›®ã®è©±ãŒå¤šã‹ã£ãŸã®ã§ã€æ¬¡ã¯ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è£œåŠ©ã®è©±ã‚’ã—ã¾ã—ã‚‡ã†ã€‚
æ­£ç›´ã«è¨€ã£ã¦ã€Lua ã¨ã„ã†è¨€èªè‡ªä½“ã¯ãã“ã¾ã§æ›¸ãã‚„ã™ã„ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãã®æ›¸ãå¿ƒåœ°ã«ãŠã„ã¦ã€[language server](https://github.com/LuaLS/lua-language-server) ã®å½±éŸ¿ã¯ç„¡è¦–ã§ããªã„ã§ã—ã‚‡ã†ã€‚

toml ãƒ•ã‚¡ã‚¤ãƒ«ã«åŸ‹ã‚è¾¼ã‚“ã§ã„ã‚‹ä»¥ä¸Šã€diagnostic ãªã©ã‚’é©åˆ‡ã«å‡ºã™ã®ã¯ä¸å¯èƒ½ã«æ€ãˆã‚‹ã§ã—ã‚‡ã†ã‹ã€‚

ãã®è§£æ±ºç­–ã«ãªã‚‹ã®ãŒ [vim-partedit](https://github.com/thinca/vim-partedit) ã§ã™ã€‚
ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã€ãƒãƒƒãƒ•ã‚¡ã®ä¸€éƒ¨åˆ†ã‚’åˆ‡ã‚Šå‡ºã—ã¦ç·¨é›†ã—ã€å¤‰æ›´ã‚’å…ƒã®ãƒãƒƒãƒ•ã‚¡ã«åæ˜ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

[context_filetype.vim](https://github.com/Shougo/context_filetype.vim) ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ç°¡å˜ã« `hook_*` ã‚„ `lua_*` ã®ç¯„å›²ã‚’ partedit.vim ã«æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ç§ã®è¨­å®šã‚’è¼‰ã›ã¦ãŠãã¾ã™ã€‚
`<C-p>` ã§èµ·å‹•ã—ã€`Q` ã§é–‰ã˜ã¾ã™ã€‚

```toml
[[plugins]]
repo = 'thinca/vim-partedit'
on_cmd = 'Partedit'
on_func = 'partedit#start'
hook_add = '''
    let g:partedit#prefix_pattern = '\s*'
    let g:partedit#auto_prefix = 0
'''
[plugins.ftplugin]
toml_markdown = '''
    nnoremap <buffer> <C-p> <Cmd>call <SID>operator_partedit()<CR>
    function! s:operator_partedit() abort
      let context = context_filetype#get()
      if context.range == [[0, 0], [0, 0]]
        echohl WarningMsg
        echomsg 'Context is not found'
        echohl NONE
        return
      endif
      call partedit#start(context.range[0][0], context.range[1][0],
            \ {'filetype': context.filetype})
      nnoremap <buffer><nowait> Q <Cmd>w<CR><Cmd>ParteditEnd<CR>
    endfunction
'''
```

### null-ls ã§ stylua ã‚’ä½¿ã£ã¦ã„ã‚‹æ–¹å‘ã‘ã®è¿½åŠ æƒ…å ±

partedit ã®ãƒãƒƒãƒ•ã‚¡ã§ã¯ã€æ®‹å¿µãªãŒã‚‰ null-ls ãŒå‹•ãã¾ã›ã‚“ã€‚
ã©ã†ã‚„ã‚‰ null-ls ã¯ã€ãƒãƒƒãƒ•ã‚¡åãŒå®Ÿåœ¨ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã ã¨èµ·å‹•ã—ãªã„ã‚ˆã†ã§ã™ã€‚
ç§ã¯ `:%!stylua -` ã«åˆ†å²ã•ã›ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

```lua
---@return boolean
local function is_active_null_ls()
  for _, client in ipairs(vim.lsp.get_active_clients({ bufnr = 0 })) do
    if client.name == "null-ls" then
      return true
    end
  end
  return false
end

api.nvim_create_user_command("Format", function()
  if not is_active_null_ls() and vim.bo.filetype == "lua" then
    vim.cmd("KeepCursor %!stylua -f ~/.config/stylua.toml -")
  else
    vim.lsp.buf.format()
  end
end, {})
```

```vim
" plugin/vimrc.vim
command! -nargs=+ KeepCursor call vimrc#keep_cursor(<q-args>)

" autoload/vimrc.vim
function vimrc#keep_cursor(cmd) abort
  let curwin_id = win_getid()
  let view = winsaveview()
  try
    execute a:cmd
  finally
    if win_getid() == curwin_id
      call winrestview(view)
    endif
  endtry
endfunction
```

# çµ‚ã‚ã‚Šã«

ç§ã¯ toml ã«ã‚ˆã‚‹ç®¡ç†ãŒã‹ãªã‚Šæ€§ã«åˆã£ã¦ã„ã¾ã—ã¦ã€ãªã‚“ã¨ã‹å¿«é©ã« Lua ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã‚ˆã†ã¨è©¦è¡ŒéŒ¯èª¤ã—ã¦ãã¾ã—ãŸã€‚
ã“ã®è¨˜äº‹ã‚’èª­ã‚“ã çš†ã•ã‚“ã‚‚ã€å¿«é©ãª Lua in toml ç”Ÿæ´»ã‚’é€ã‚Šã¾ã—ã‚‡ã†ï¼
